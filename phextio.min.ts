// phext.ts
// this monstrosity of an implementation is basically Will's stream of consciousness
// if you want to refactor it for clarity, please submit a pr
// (c) 2023-2024 Phext, Inc.
// License: MIT
// see phext.ts for the source
// compressed with https://www.toptal.com/developers/javascript-minifier
var upstream="https://github.com/wbic16/phextio",raw="",phexts={};localStorage.raw&&localStorage.raw.length>0?raw=localStorage.raw:(raw="<html>\n<head>\n<title>Reference Phext Document</title>\n</head>\n<body>\n\nYou are currently at 1.1.1/1.1.1/1.1.1.\nWe are aware of the following nodes:\n\n<a href='phext://1.1.1/1.1.1/1.1.2'>Scroll #2</a>\n<a href='phext://1.1.1/1.1.1/1.1.3'>Scroll #3</a>\n<a href='phext://1.1.1/1.1.1/1.1.4'>Scroll #4</a>\n\n</body>\n</html>\x17Scroll #2\n---------\nThis happens to be a MarkDown file.\n\n\x17Scroll #3: Just a line of text.\x17<html>\n<head>\n<title>Scroll #4</title>\n</head>\n<body>\n<a href='phext://1.1.1/1.1.1/1.1.1'>Return Home</a>\n\n<h1>Scroll #4</h1>\n</body>\n</html>",localStorage.raw=raw);var phextMode="n";const LINE_BREAK="\n",SCROLL_BREAK="\x17",SECTION_BREAK="\x18",CHAPTER_BREAK="\x19",BOOK_BREAK="\x1a",VOLUME_BREAK="\x1c",COLLECTION_BREAK="\x1d",SERIES_BREAK="\x1e",SHELF_BREAK="\x1f",LIBRARY_BREAK="\x01",F1_KEY=112,F2_KEY=113,F3_KEY=114,F4_KEY=115,F5_KEY=116,F6_KEY=117,F7_KEY=118,F8_KEY=119,F9_KEY=120,F10_KEY=121,F11_KEY=122,F12_KEY=123;var enterKey="\n",replacementDescription="ENTER",priorButton=!1,DimensionBreaks=["\x17","\x18","\x19","\x1a","\x1c","\x1d","\x1e","\x1f","\x01"];function defaultCoordinates(){var e=[];return e["\n"]=1,e["\x17"]=1,e["\x18"]=1,e["\x19"]=1,e["\x1a"]=1,e["\x1c"]=1,e["\x1d"]=1,e["\x1e"]=1,e["\x1f"]=1,e["\x01"]=1,e}var gl=!1,ns=!1,ta=!1,cs=!1,ls=!1,te=!1,tb=!1,cx=!1,cy=!1,cz=!1,wr=!1,st=!1,cb=!1,lk=!1,cp=!1,ha=!1,sa=!1,vr=!1,qr=!1,lt=!1,sd=!1,se=!1,lts=!1,qrui=!1,qrd=!1,qrl=!1,qt=!1,nodes=[],qurl="",mnt=!1,mte=!1,mss=!1,tbe=!1,tblb=!1,tbsf=!1,tbsr=!1,tbcn=!1,tbvm=!1,tbbk=!1,tbch=!1,tbsn=!1,tbsc=!1,tab_libraries=[],tab_shelves=[],tab_series=[],tab_collections=[],tab_volumes=[],tab_books=[],tab_chapters=[],tab_sections=[],tab_scrolls=[],phextCoordinate="1.1.1/1.1.1/1.1.1";function dgid(e){return document.getElementById(e)}function loadVars(){gl||(gl=dgid("goal")),ns||(ns=dgid("nodes")),ta||(ta=dgid("scroll")),cs||(cs=dgid("coords")),ls||(ls=dgid("subspace")),te||(te=dgid("tiles")),tb||(tb=dgid("tabs")),cx||(cx=dgid("coordsX")),cy||(cy=dgid("coordsY")),cz||(cz=dgid("coordsZ")),wr||(wr=dgid("whiterabbit")),st||(st=dgid("subspaceTitle")),cb||(cb=dgid("commandBar")),cp||(cp=dgid("coordinatePlate")),ha||(ha=dgid("helparea")),sa||(sa=dgid("subspaceArea")),lt||(lt=dgid("linkerText")),sd||(sd=dgid("seed")),se||(se=dgid("seeds")),lts||(lts=dgid("linkerStatus")),qrui||(qrui=dgid("qrcode")),qrl||(qrl=dgid("qrlabel")),qt||(qt=dgid("quest")),mnt||(mnt=dgid("modeNestedTabs")),mte||(mte=dgid("modeTiles")),mss||(mss=dgid("modeSubspace")),te||(tbe=dgid("tab_editor")),tblb||(tblb=dgid("tab_library")),tbsf||(tbsf=dgid("tab_shelf")),tbsr||(tbsr=dgid("tab_series")),tbcn||(tbcn=dgid("tab_collection")),tbvm||(tbvm=dgid("tab_volume")),tbbk||(tbbk=dgid("tab_book")),tbch||(tbch=dgid("tab_chapter")),tbsn||(tbsn=dgid("tab_section")),tbsc||(tbsc=dgid("tab_scroll"));for(var e=1;e<=7;++e)tab_libraries[e]=dgid("lb"+e),tab_shelves[e]=dgid("sf"+e),tab_series[e]=dgid("sr"+e),tab_collections[e]=dgid("cn"+e),tab_volumes[e]=dgid("vm"+e),tab_books[e]=dgid("bk"+e),tab_chapters[e]=dgid("ch"+e),tab_sections[e]=dgid("sn"+e),tab_scrolls[e]=dgid("sc"+e);localStorage.seed&&(sd.value=localStorage.seed)}function updateCoordinate(){phextCoordinate=cx.value+"/"+cy.value+"/"+cz.value}var coords=defaultCoordinates(),target=defaultCoordinates(),scrollFound=!1;function loadPhext(){raw=ls.value,coords=defaultCoordinates();var e=cz.value.split("."),t=cy.value.split("."),s=cx.value.split(".");e.length>=1&&(target["\x01"]=e[0]),e.length>=2&&(target["\x1f"]=e[1]),e.length>=3&&(target["\x1e"]=e[2]),t.length>=1&&(target["\x1d"]=t[0]),t.length>=2&&(target["\x1c"]=t[1]),t.length>=3&&(target["\x1a"]=t[2]),s.length>=1&&(target["\x19"]=s[0]),s.length>=2&&(target["\x18"]=s[1]),s.length>=3&&(target["\x17"]=s[2]),scrollFound=!1,qt.innerHTML="",nodes=[],totalScrolls=1,raw.split("\x01").forEach(e=>processLibrary(e)),scrollFound||(ta.value=""),qt.innerHTML=nodes.join("\n")}function dimensionBreak(e){"\x01"==e&&(++coords["\x01"],coords["\x1f"]=1,coords["\x1e"]=1,coords["\x1d"]=1,coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1f"==e&&(++coords["\x1f"],coords["\x1e"]=1,coords["\x1d"]=1,coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1e"==e&&(++coords["\x1e"],coords["\x1d"]=1,coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1d"==e&&(++coords["\x1d"],coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1c"==e&&(++coords["\x1c"],coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1a"==e&&(++coords["\x1a"],coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x19"==e&&(++coords["\x19"],coords["\x18"]=1,coords["\x17"]=1),"\x18"==e&&(++coords["\x18"],coords["\x17"]=1),"\x17"==e&&++coords["\x17"]}function processLibrary(e){e.split("\x1f").forEach(e=>processShelf(e)),dimensionBreak("\x01")}function processShelf(e){e.split("\x1e").forEach(e=>processSeries(e)),dimensionBreak("\x1f")}function processSeries(e){e.split("\x1d").forEach(e=>processCollection(e)),dimensionBreak("\x1e")}function processCollection(e){e.split("\x1c").forEach(e=>processVolume(e)),dimensionBreak("\x1d")}function processVolume(e){e.split("\x1a").forEach(e=>processBook(e)),dimensionBreak("\x1c")}function processBook(e){e.split("\x19").forEach(e=>processChapter(e)),dimensionBreak("\x1a")}function processChapter(e){e.split("\x18").forEach(e=>processSection(e)),dimensionBreak("\x19")}function processSection(e){e.split("\x17").forEach(e=>processScroll(e)),dimensionBreak("\x18")}function coordinatesMatch(e,t){return e["\x17"]==t["\x17"]&&e["\x18"]==t["\x18"]&&e["\x19"]==t["\x19"]&&e["\x1a"]==t["\x1a"]&&e["\x1c"]==t["\x1c"]&&e["\x1d"]==t["\x1d"]&&e["\x1e"]==t["\x1e"]&&e["\x1f"]==t["\x1f"]&&e["\x01"]==t["\x01"]}function coordToString(e){var t,s=e["\x01"]+"."+e["\x1f"]+"."+e["\x1e"];return s+"/"+(e["\x1d"]+"."+e["\x1c"]+"."+e["\x1a"])+"/"+(e["\x19"]+"."+e["\x18"]+".")+e["\x17"]}function coordinateHit(e){var t=e["\x01"]+"."+e["\x1f"]+"."+e["\x1e"],s=e["\x1d"]+"."+e["\x1c"]+"."+e["\x1a"],o=e["\x19"]+"."+e["\x18"]+"."+e["\x17"];return"<a href='"+getPhextUrl(o,s,t)+"'>@"+t+"/"+s+"/"+o+"</a>"}function drawNode(e,t){e["\x17"];var s=t;return t.length>250&&(s=t.substring(0,250),s+="..."),"<div class='node' onclick='loadNode("+coordToString(e)+");'>"+coordinateHit(e)+" <input type='button' onclick='editScroll("+e+");' value='Edit' /><br />"+s+"</div>"}var totalScrolls=1;function processScroll(e){if(coordinatesMatch(target,coords)){ta.value=e,scrollFound=!0;var t=e.split("\n").length;t<100?ta.rows=t:ta.rows=100}e.length>0&&(nodes[totalScrolls]=drawNode(coords,e),++totalScrolls),dimensionBreak("\x17")}function safeEncode(e){return!e||e.length<1?"":encodeURIComponent(e.replaceAll("'","%27"))}function updateQR(){qr||(qr=new QRCode(document.getElementById("qrcode"),{text:"https://phext.io/index.html",width:640,height:640}),qrui.style.background="#000"),qr.clear(),qr.makeCode(qurl)}var timeoutDelay=1e3;function getPhextUrl(e,t,s){return qurl="https://phext.io/index.html?seed="+safeEncode(sd.value)+"&cz="+safeEncode(s)+"&cy="+safeEncode(t)+"&cx="+safeEncode(e)+"&"+phextMode+"="+safeEncode(raw),lt.value=qurl,qrd&&clearTimeout(qrd),qrd=setTimeout(updateQR,timeoutDelay),lts.innerHTML="",qurl}function greypill(){gl.style.display="block",ns.style.display="block",wr.style.display="none",ta.style.display="none",cp.style.display="none",ha.style.display="none",sa.style.display="none",qrui.style.display="block",qrl.style.display="none",qt.style.display="none"}function redpill(e){phextMode="r",st.innerHTML="Follow the <a class='small' href='white-rabbit.html'>White Rabbit</a>.",gl.style.display="none",ns.style.display="none",wr.style.display="block",ta.style.display="block",cp.style.display="block",ha.style.display="block",sa.style.display="block",qrui.style.display="block",qrl.style.display="block",qt.style.display="block",updateCoordinate(),loadPhext(),getPhextUrl(cx.value,cy.value,cz.value),e&&saveContent()}function saveContent(){if(localStorage.raw=ls.value,sd.value&&0!=sd.value.trim().length||(sd.value="holiday"),!phexts[sd.value]){var e=document.createElement("option");e.value=sd.value,e.innerHTML=sd.value,e.selected=!0,se.appendChild(e)}phexts[sd.value]=ls.value,localStorage.seed=sd.value,localStorage.phexts=JSON.stringify(phexts)}function bluepill(){phextMode="b",gl.style.display="none",ns.style.display="none",wr.style.display="none",ta.style.display="none",cp.style.display="none",ha.style.display="none",sa.style.display="block",qrui.style.display="none",qrl.style.display="none",qt.style.display="none",ta.value=raw,ta.rows=raw.split("\n").length,st.innerHTML="Believe",ta.value=raw,dgid("linker").href=getPhextUrl(cx.value,cy.value,cz.value)+"#BluePill"}function whitepill(){window.open(upstream)}function whiteRabbit(){window.open("whiterabbit.html")}function copyUrl(){getPhextUrl(),saveContent(),navigator.clipboard.writeText(qurl),lts.innerHTML="URL copied!"}function setValue(e,t){var s=dgid(e);s&&s.value&&(s.value=t)}function startup(){setValue("pscrollbreak","\x17"),setValue("psectionbreak","\x18"),setValue("pchapterbreak","\x19"),setValue("pbookbreak","\x1a"),setValue("pvolumebreak","\x1c"),setValue("pcollectionbreak","\x1d"),setValue("pseriesbreak","\x1e"),setValue("pshelfbreak","\x1f"),setValue("plibrarybreak","\x01"),loadVars(),edit("tabs");var e=Object.fromEntries(new URLSearchParams(window.location.search).entries());e.cz&&(cz.value=e.cz),e.cy&&(cy.value=e.cy),e.cx&&(cx.value=e.cx),e.seed&&(localStorage.seed=e.seed,sd.value=e.seed),localStorage.phexts&&Object.keys(phexts=JSON.parse(localStorage.phexts)).forEach(e=>{var t=document.createElement("option");t.value=e,t.innerHTML=e,e==sd.value&&(t.selected=!0),se.appendChild(t)}),phexts&&phexts[e.seed]&&(localStorage.raw=localStorage.phexts[e.seed]),localStorage.raw&&(raw=localStorage.raw),ls&&(ls.value=raw),e.r&&(raw=e.r.replaceAll("%27","'"),ls.value=raw,redpill(!1)),e.b&&(raw=e.b.replaceAll("%27","'"),ls.value=raw,bluepill())}function setEnterType(e,t,s){enterKey=s;var o=dgid("CB"+e+"_"+t);o&&(priorButton&&(priorButton.style.borderStyle="",priorButton.style.backgroundColor=""),o.style.borderStyle="inset",o.style.backgroundColor="orange",replacementDescription="&lt;"+o.value+"&gt;",priorButton=o)}function phextMods(e,t){if(!remapFunctionKeys[e])return;for(var s=F1_KEY;s<=121;++s)if(t.keyCode==s){t.preventDefault();var o=dgid("CB"+e+"_"+(t.keyCode-F1_KEY+2));o&&o.click();continue}if("Enter"!==t.key)return;t.preventDefault();var l=document.activeElement;let r=l.selectionStart,a=l.value.substring(0,r),n=l.value.substring(l.selectionEnd,l.value.length),d="\n"==enterKey?enterKey:enterKey+"\n";l.value=a+d+n,l.selectionStart=l.selectionEnd=r+1,l.focus()}var remapFunctionKeys=[];function toggle(e){var t=dgid("disabler"+e);if(!t)return;let s="Disable"===t.value;t.value=s?"Enable":"Disable",remapFunctionKeys[e]=s}function chooseSeed(e){sd.value=e.value,ls.value=phexts[e.value]}function removeSeed(){phexts[sd.value]&&(delete phexts[sd.value],Object.keys(se.options).forEach(e=>{se.options[e]&&se.options[e].value==sd.value&&se.options.remove(e)}),sd.value=se.options[se.selectedIndex].value,localStorage.seed=sd.value,localStorage.phexts=JSON.stringify(phexts))}function edit(e){sd&&(sd.style.display="block"),cp&&(cp.style.display="block");var t="tabs"==e;tb&&(tb.style.display=t?"block":"none"),mnt&&(mnt.style.border=t?"2px solid":"");var s="tiles"==e;te&&(te.style.display=s?"block":"none"),mte&&(mte.style.border=s?"2px solid":"");var o="subspace"==e,l=o?"block":"none";mss&&(mss.style.border=o?"2px solid":""),ls&&(ls.style.display=l),st&&(st.style.display=l),ta&&(ta.style.display=l),cb&&(cb.style.display=l),tbsf&&(tbsf.style.display="none"),tbsr&&(tbsr.style.display="none"),tbcn&&(tbcn.style.display="none"),tbvm&&(tbvm.style.display="none"),tbbk&&(tbbk.style.display="none"),tbch&&(tbch.style.display="none"),tbsn&&(tbsn.style.display="none"),tbsc&&(tbsc.style.display="none")}function tab_break(e){tbsf.style.display=e>=1?"block":"none",tbsr.style.display=e>=2?"block":"none",tbcn.style.display=e>=3?"block":"none",tbvm.style.display=e>=4?"block":"none",tbbk.style.display=e>=5?"block":"none",tbch.style.display=e>=6?"block":"none",tbsn.style.display=e>=7?"block":"none",tbsc.style.display=e>=8?"block":"none"}function jump(e,t,s){var o=cz.value.split("."),l=cy.value.split("."),r=cx.value.split(".");if("lb"==t){tab_break(1),o[0]=s;for(var a=1;a<=7;++a)tab_libraries[a].style.border="",tab_libraries[a].style.backgroundColor=""}if("sf"==t){tab_break(2),o[1]=s;for(var a=1;a<=7;++a)tab_shelves[a].style.border="",tab_shelves[a].style.backgroundColor=""}if("sr"==t){tab_break(3),o[2]=s;for(var a=1;a<=7;++a)tab_series[a].style.border="",tab_series[a].style.backgroundColor=""}if("cn"==t){tab_break(4),l[0]=s;for(var a=1;a<=7;++a)tab_collections[a].style.border="",tab_collections[a].style.backgroundColor=""}if("vm"==t){tab_break(5),l[1]=s;for(var a=1;a<=7;++a)tab_volumes[a].style.border="",tab_volumes[a].style.backgroundColor=""}if("bk"==t){tab_break(6),l[2]=s;for(var a=1;a<=7;++a)tab_books[a].style.border="",tab_books[a].style.backgroundColor=""}if("ch"==t){tab_break(7),r[0]=s;for(var a=1;a<=7;++a)tab_chapters[a].style.border="",tab_chapters[a].style.backgroundColor=""}if("sn"==t){tab_break(8),r[1]=s;for(var a=1;a<=7;++a)tab_sections[a].style.border="",tab_sections[a].style.backgroundColor=""}if("sc"==t){tab_break(9),r[2]=s;for(var a=1;a<=7;++a)tab_scrolls[a].style.border="",tab_scrolls[a].style.backgroundColor=""}e.style.border="1px solid orange",e.style.backgroundColor="#6560e0",cz.value=o[0]+"."+o[1]+"."+o[2],cy.value=l[0]+"."+l[1]+"."+l[2],cx.value=r[0]+"."+r[1]+"."+r[2]}function tab_value(e,t){return parseInt(tab_libraries[t].value.replace(e,""))-1}function tab_shift(e,t){var s="";if("lb"==e&&(s="Library "),"sf"==e&&(s="Shelf "),"sr"==e&&(s="Series "),"cn"==e&&(s="Collection "),"vm"==e&&(s="Volume "),"bk"==e&&(s="Book "),"ch"==e&&(s="Chapter "),"sn"==e&&(s="Section "),"sc"==e&&(s="Scroll "),0!=s.length){var o=tab_value(s,1);"add"==t&&(o+=1),"sub"==t&&(o-=1),o<0&&(o=0),o>100&&(o=100);for(var l=1;l<=7;++l)tab_libraries[l].value=s+(l+o)}}remapFunctionKeys[1]=!0,remapFunctionKeys[2]=!0;